<!doctype html>
<!--Calvin Chen-->

<html>
	<head>
		<title>Simple Map</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <style>
            /* Always set the map height explicitly to define the size of the div
            * element that contains the map. */
            #map {
            height: 100%;
            }
            /* Optional: Makes the sample page fill the window. */
            html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            }
            #floating-panel {
                position: absolute;
                top: 10px;
                left: 25%;
                z-index: 5;
                background-color: #fff;
                padding: 5px;
                border: 1px solid #999;
                text-align: center;
                font-family: 'Roboto','sans-serif';
                line-height: 30px;
                padding-left: 10px;
            }
        </style>
        <script src='BpTspSolver.js'></script>
		<script type = "text/javascript">
            function equalArrays(a1, a2) {
                if (a1.length != a2.length)
                    return false;
                for (var i = 0; i < a1.length; i++) {
                    if (!(markersEqual(a1[i], a2[i])))
                        return false;
                }
                return true;
            }
            
            function rad(x) {
                return x * Math.PI / 180;
            };

            //function takes in 2 marker obj
            function markerDistance(place1, place2){
                place1 = place1.getPosition();
                place2 = place2.getPosition();
                var R = 6378137; // Earth’s mean radius in meter
                var dLat = rad(place1.lat() - place1.lat());
                var dLong = rad(place2.lng() - place1.lng());
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(rad(place1.lat())) * Math.cos(rad(place2.lat())) *
                    Math.sin(dLong / 2) * Math.sin(dLong / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c;
                return d; // returns the distance in meter
            }

            // function markerDistance(place1, place2, callback) {
            //    service = new google.maps.DirectionsService();
            //    //var ttl = 0;
            //    //sets up google's routing service
            //    service.route({
            //        origin: place1.getPosition(),
            //        destination: place2.getPosition(),
            //        travelMode: 'DRIVING',
            //        unitSystem: google.maps.UnitSystem.IMPERIAL,
            //    }, function (result, status) {
            //        if (status == 'OK') {
            //            //adds up all leg distances in route
            //            legs = result.routes[0].legs;
            //            ttl = 0;
            //            for (var i = 0; i < legs.length; i++) {
            //                ttl += legs[i].distance.value
            //            }
            //            console.log(ttl)
            //            callback(ttl);
            //        }
            //        }
            //    )
               //setTimeout(Function.prototype, 10000);
            //    return ttl;
            // }

            //  function markerDistance(place1, place2) {
            //     var service = new google.maps.DirectionsService();
            //         //sets up google's routing service
            //     var ttl = 0;
                
            //     var flag = false;
            //     var request = {
            //         origin: place1.getPosition(),
            //         destination: place2.getPosition(),
            //         travelMode: 'DRIVING',
            //         unitSystem: google.maps.UnitSystem.IMPERIAL,
            //     };
                
            //     //console.log("routing...");
            //     // const route = await service.route(request, (res, status) => { 
            //     //     if(status) console.log(status);
            //     //     return res; 
            //     // });
            //     //console.log(`REEEE: ${route}`);
            // }
                
            // function markerDist(locations){
            //     var service = new google.maps.DistanceMatrixService();
            //     var result = service.getDistanceMatrix(
            //         {
            //             origins: locations,
            //             destinations: locations,
            //             travelMode: 'DRIVING',
            //             unitSystem: google.maps.UnitSystem.IMPERIAL,
            //             avoidHighways: false,
            //             avoidTolls: false
            //         }, markerCallback);
            // }

            //async function markerDist(locations){
            //     var service = new google.maps.DistanceMatrixService();
            //     // var result = await service.getDistanceMatrix(
            //     //     {
            //     //         origins: locations,
            //     //         destinations: locations,
            //     //         travelMode: 'DRIVING',
            //     //         unitSystem: google.maps.UnitSystem.IMPERIAL,
            //     //     });
            //     // console.log(result);
            //     var result = service.getDistanceMatrix(
            //         {
            //             origins: locations,
            //             destinations: locations,
            //             travelMode: 'DRIVING',
            //             unitSystem: google.maps.UnitSystem.IMPERIAL,
            //         }, markerCallback); 
            // }
            // async function markerDist(locations) {
            //     var result = await helper(locations);
            //     console.log("ret: ", result);
            // }

            // async function helper(locations) {
            //     var service = new google.maps.DistanceMatrixService();
            //     await service.getDistanceMatrix({
            //         origins: locations,
            //         destinations: locations,
            //         travelMode: 'DRIVING',
            //         unitSystem: google.maps.UnitSystem.IMPERIAL,
            //     }, function(res, status) {
            //         console.log("Res:", res);
            //         return res;
            //     });
            // }

            // function markerCallback(response, status) {
            //     if (status == 'OK') {
            //         var origins = response.originAddresses;
            //         var destinations = response.destinationAddresses;
            //         //return response;

            //         for (var i = 0; i < origins.length; i++) {
            //             var results = response.rows[i].elements;
            //             for (var j = 0; j < results.length; j++) {
            //                 var element = results[j];
            //                 var distance = element.distance.text;
            //                 var duration = element.duration.text;
            //                 var from = origins[i];
            //                 var to = destinations[j];
            //                 console.log(from, to, distance)
            //             }
            //         }
                   
            //         return response;
            //     }
            // }
            
            // async function route(request){
            //     var service = new google.maps.DirectionsService();
            //     try{
            //         result = await service.route(request);
            //     } catch (e){
            //         console.print("no bueno")
            //     }
            // }

       
            function markersEqual(m1, m2) {
                return (m1.getPosition().toString() == m2.getPosition().toString());
            }

            function avgLatLng(locations, resultsMap) {
                lat = 0;
                lng = 0;
                for (var i = 0; i < locations.length; i++) {
                    lat += locations[i].getPosition().lat();
                    lng += locations[i].getPosition().lng();
                }
                lat = lat / locations.length;
                lng = lng / locations.length;
                var marker = new google.maps.Marker({
                    map: resultsMap,
                    position: { lat, lng },
                    title: 'Avg'
                });
                //console.log(marker);
                //console.log(lat);
                return new google.maps.LatLng(lat, lng);
            }

            // async function help(place1, place2) {
            //     var markerPromise = await markerDistance(place1, place2);
            //     console.log("asjdflk:", markerPromise);
            //     var distance;
            //     //markerPromise.then(function (value) {
            //     //    console.log(value);
            //     //    distance = value;
            //     //    console.log(distance);
            //     //});
            //     return distance;
            // }

            //finds the closest centroid from place
            function closestLocation(place, centroids){
                minidx = 0;
                //var markerPromise = markerDistance(place, centroids[0]);
                //var distance;
                //markerPromise.then(function (value) {
                //    console.log(value);
                //    distance = value;
                //});
                var distance = markerDistance(place, centroids[0]);
                //console.log(distance);
                for (i = 0; i < centroids.length; i++) {
                    var currDist = markerDistance(place, centroids[i]);
                    //markerPromise = markerDistance(place, centroids[i]);
                    //markerPromise.then(function (value) {
                    //    currDist = value;
                    //});
                    //var currDist = help(place, centroids[i]);
                    //console.log(i, currDist, distance);
                    if (currDist < distance) {
                        minidx = i;
                        distance = currDist;
                    }
                }
                return minidx;

                //if (i >= centroids.length) {
                //    console.log("hi:", min);
                //    return min;
                //}

                //markerDistance(place, centroids[i], function (dist) {
                //    if (i == centroids.length-1) {
                //        console.log("hi:", min, dist, distance);
                //        if (dist < distance) {
                //            console.log('alskdjflkjsaldf', i);
                //            return i;
                //        }
                //        return min;
                //    }

                //    if (dist < distance || distance == -1)
                //        return closestLocation(place, centroids, dist, i+1, i);
                //    else
                //        return closestLocation(place, centroids, distance, i+1, min);
                //});
            }

            //function factorial(n) {
            //    if (n == 0)
            //        return 1;
            //    else {
            //        return (n * factorial(n - 1));
            //    }
            //}

            // a = new Point(0, 0);
            // b = new Point(3, 4);
            // c = new Point(5, 5);
            // d = new Point(1, 7);
            // e = new Point(5, 9);
            // f = new Point(6, 2);
            // points = [a, b, c, d, e, f]

            //k-means clustering
            //function mTSP(points, people) {
            //    centroids = new Array(people);
            //    routes = new Array(people);

            //    //Generate random centroids
            //    for (var i = 0; i < people; i++) {
            //        centroids[i] = new Point(Math.random() * 10, Math.random() * 10);
            //    }

            //    convergence = false;

            //    while (!convergence) {
            //        //reset clusters
            //        for (var i = 0; i < routes.length; i++)
            //            routes[i] = new Array()

            //        //separate into clusters
            //        for (var i = 0; i < points.length; i++) {
            //            routes[points[i].closestPoint(centroids)].push(points[i]);
            //        }

            //        //find new centroid
            //        newCentroids = new Array(people)
            //        for (var i = 0; i < centroids.length; i++) {
            //            newCentroids[i] = avg(routes[i])
            //        }
            //        //console.log(newCentroids);
            //        //console.log(centroids)
            //        convergence = equalArrays(centroids, newCentroids);
            //        centroids = newCentroids;
            //    }

            //    //console.log(routes)
            //    return routes;
            //}
            
            //Check if a num is in an array
            function isNumMembership(num, list){
                for(var i = 0; i < list.length; i++){
                    if(num == list[i])
                        return true;
                }
                return false;
            }

            //Generate n random numbers from 0 to end with no repeats
            function random_num(n, end){
                var result = []
                for(var i = 0; i < n; i++){
                    var num = Math.floor((Math.random() * end));
                    while(isNumMembership(num, result))
                        num = Math.floor((Math.random() * end));
                    result.push(num);
                }
                return result;
            }
            
            function addAddressCallback(address, latLng){
                //console.log(address, latLng);
            }
            function onSolveCallback(){}

            //locations = set of locations, people = num of people
            function maps_mTSP(locations, people) {
                centroids = new Array(people);
                clusters = new Array(people);

                //Generate random centroids
                // for (var i = 0; i < people; i++) {
                //     bool1 = Math.random() < 0.5 ? -1 : 1;
                //     bool2 = Math.random() < 0.5 ? -1 : 1;
                //     tmp = new google.maps.LatLng(bool1 * Math.random()*90, bool2 * Math.random()*180);
                //     //wrap centroids into markers for streamlining
                //     centroids[i] = new google.maps.Marker({
                //         position: tmp,
                //         title: 'Centroid'
                //     });
                // }

                //Use random points as centroid
                pos = random_num(people, locations.length);
                for(var i = 0; i < people; i++){
                    centroids[i] = new google.maps.Marker({
                        position: locations[pos[i]].getPosition(),
                        title: 'Centroid'
                    });
                }

                convergence = false;

                while (!convergence) {
                    //reset clusters
                    for (var i = 0; i < clusters.length; i++)
                        clusters[i] = new Array()

                    //separate into clusters
                    for (var i = 0; i < locations.length; i++) {
                        clusters[closestLocation(locations[i],centroids)].push(locations[i]);
                    }

                    //find new centroid
                    newCentroids = new Array(people)
                    for (var i = 0; i < centroids.length; i++) {
                        tmp = avgLatLng(clusters[i])
                        newCentroids[i] = new google.maps.Marker({
                            position: tmp,
                            title: 'Centroid'
                        });
                    }
                    //console.log(newCentroids);
                    //console.log(centroids)
                    convergence = equalArrays(centroids, newCentroids);
                    centroids = newCentroids;
                    //console.log('hi')
                }

                //console.log(routes)
                
                // var routes = new Array(people);
                // for(var i = 0; i < people; i++){
                //     tsp = new BpTspSolver();

                //     // Set your preferences
                //     tsp.setAvoidHighways(false);
                //     tsp.setTravelMode(google.maps.DirectionsTravelMode.DRIVING);

                //     for(var j = 0; j < clusters[k].length; j++){
                //         tsp.addAddress(clusters[k][j].getTitle(), addAddressCallback);
                //     }
                //     tsp.solveRoundTrip(onSolveCallback);
                //     routes[i] = tsp.getOrder();
                // }

                // var routes = []
                // for(var i = 0; i < people; i++){
                //     var waypoints1 = [];
                //     for( var j = 2; j < clusters[i].length; j++){
                //         var tmp = {
                //             location: clusters[i][j].getTitle(),
                //             stopover: true,
                //         }
                //         waypoints1.push(tmp);
                //     }
                //     var request = {
                //         origin: clusters[i][0].getTitle(),
                //         destination: clusters[i][1].getTitle(),
                //         travelMode: 'DRIVING',
                //         waypoints: waypoints1,
                //         optimizeWaypoints: true,
                //     }
                //     var service = new google.maps.DirectionsService();
                //     service.route(request, function(result, status, i){
                //         routes.push(clusters[i][0].getTitle());
                //         for(var k = 0; k < result.routes[0].waypoint_order.length; k++){
                //             routes.push(clusters[i][result.routes[0].waypoint_order[k]].getTitle());
                //         }
                //         routes.push(clusters[i][1].getTitle());
                //         //insert routes into db
                //         console.log(hi);
                //     });
                //     //routes[i] = result.waypoint_order;
                // }
                return clusters
                //return routes;
            }
            //array1 = [a, b];
            //array2 = [a, b];
            //console.log(equalArrays(array1, array2))
            //mTSP(points, 2);

            //assuming locations is list of address strings
            function dropMarkers(locations) {
                var geocoder = new google.maps.Geocoder();
                for (var i = 0; i < locations.length; i++) {
                    geocoder.geocode({ 'address': locations[i] }, function (results, status) {
                        if (status === 'OK') {
                            //resultsMap.setCenter(results[0].geometry.location);
                            var marker = new google.maps.Marker({
                                map: map,
                                position: results[0].geometry.location,
                                //label: 'A'
                            });
                            //locations.push(marker);
                            //console.log(locations);
                        } else {
                            alert('Geocode was not successful for the following reason: ' + status);
                        }
                    });
                }
            }

            test = ["8059 Crescent Ave. Staten Island, NY 10312", "563 Willow St. Brooklyn, NY 11201", "9778 West Honey Creek St. North Tonawanda, NY 14120",
                "368 Oakwood Ave. Webster, NY 14580", "53 W. Pilgrim Dr. Brooklyn, NY 11204"];
		</script>	
	</head>

    <body>
        <div id="map"></div>
        <div id="floating-panel">
            <input id="address" type="textbox" value="Sydney, NSW">
            <input id="submit" type="button" value="Geocode">
        </div>
        <div id="map"></div>
        <script>
            var map;
            function initMap() {
                    map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 12,
                        center: { lat: 43.2994, lng: -74.2179 }
                });
                var geocoder = new google.maps.Geocoder();

                document.getElementById('submit').addEventListener('click', function () {
                    geocodeAddress(geocoder, map);
                });
            }

            locations = new Array();
            locations_name = new Array();
            //Google code
            function geocodeAddress(geocoder, resultsMap) {
                var address = document.getElementById('address').value;
               // document.getElementById('start').value = 
                geocoder.geocode({ 'address': address }, function (results, status) {
                    if (status === 'OK') {
                        resultsMap.setCenter(results[0].geometry.location);
                        var marker = new google.maps.Marker({
                            map: resultsMap,
                            position: results[0].geometry.location,
                            title: address
                        });
                        locations.push(marker);
                        locations_name.push(address);
                        console.log(locations);
                    } else {
                        alert('Geocode was not successful for the following reason: ' + status);
                    }
                });
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCoHhrD9QVajfK8pnquBi9y4veMFbVGedo&callback=initMap"
                async defer></script>
    </body>
</html>